# 難病・希少疾患支援団体検索システム - システムアーキテクチャと検索フロー

このドキュメントでは、難病・希少疾患支援団体検索システムのアーキテクチャ、検索フロー、情報収集プロセスについて図解と共に説明します。

## 1. システム全体アーキテクチャ

```
+----------------------------------+       +----------------------------------+
|          フロントエンド          |       |           バックエンド           |
|        (React + TypeScript)      |       |           (FastAPI)             |
+----------------------------------+       +----------------------------------+
|                                  |       |                                  |
|  +----------------------------+  |       |  +----------------------------+  |
|  |      ユーザーインターフェース  |  |       |  |      API エンドポイント     |  |
|  +----------------------------+  |       |  +----------------------------+  |
|  | - 検索フォーム              |  |       |  | - 疾患検索 API             |  |
|  | - 疾患リスト表示            |  |       |  | - 組織情報 API             |  |
|  | - 疾患詳細表示              |  |       |  | - LLM 連携 API             |  |
|  | - 組織情報表示              |  |       |  | - 検証 API                 |  |
|  | - 検索語エディタ            |  |       |  | - 検索語管理 API           |  |
|  | - 人間検証パネル            |  |       |  | - 統計情報 API             |  |
|  | - 統計情報表示              |  |       |  +----------------------------+  |
|  +----------------------------+  |       |                                  |
|                                  |       |  +----------------------------+  |
|  +----------------------------+  |       |  |      データ処理モジュール     |  |
|  |      状態管理              |  |       |  +----------------------------+  |
|  +----------------------------+  |       |  | - 疾患データローダー        |  |
|  | - 検索状態                 |  |       |  | - 検索語ジェネレーター      |  |
|  | - 疾患データ               |  |       |  | - 組織情報マネージャー      |  |
|  | - 組織情報                 |  |       |  | - 統計マネージャー          |  |
|  | - 検証状態                 |  |       |  +----------------------------+  |
|  | - トークン使用量            |  |       |                                  |
|  +----------------------------+  |       |  +----------------------------+  |
|                                  |       |  |      LLM 連携モジュール      |  |
|  +----------------------------+  |       |  +----------------------------+  |
|  |      API クライアント       |  |       |  | - Ollama プロバイダー       |  |
|  +----------------------------+  |       |  | - LM Studio プロバイダー     |  |
|  | - 疾患 API                 |  |       |  | - MLX プロバイダー          |  |
|  | - 組織 API                 |  |       |  | - llama.cpp プロバイダー     |  |
|  | - LLM API                  |  |       |  +----------------------------+  |
|  | - 検証 API                 |  |       |                                  |
|  | - 検索語 API               |  |       |  +----------------------------+  |
|  +----------------------------+  |       |  |    ウェブスクレイピングモジュール |  |
|                                  |       |  +----------------------------+  |
+----------------------------------+       |  | - 検索エンジン連携          |  |
                                           |  | - HTML パーサー             |  |
                                           |  | - コンテンツ抽出            |  |
                                           |  | - URL 検証                 |  |
                                           |  +----------------------------+  |
                                           |                                  |
                                           |  +----------------------------+  |
                                           |  |      検証モジュール          |  |
                                           |  +----------------------------+  |
                                           |  | - LLM 一次検証             |  |
                                           |  | - LLM 二次検証             |  |
                                           |  | - 人間検証管理             |  |
                                           |  +----------------------------+  |
                                           |                                  |
                                           +----------------------------------+
                                                          |
                                                          v
+----------------------------------+       +----------------------------------+
|        ローカル LLM モデル        |       |          データストレージ         |
+----------------------------------+       +----------------------------------+
| - Qwen30B-A3B (LM Studio)       |       | - 疾患データ                    |
| - Qwen32B (LM Studio)           |       | - 組織情報                      |
| - Llama3 70B 4bit (Ollama)      |       | - 検索統計                      |
| - Llama4 Scour 4bit (Ollama)    |       | - 検証履歴                      |
+----------------------------------+       | - トークン使用量                 |
                                           +----------------------------------+
```

## 2. 検索フローとデータ処理パイプライン

```
+----------------+     +----------------+     +----------------+     +----------------+
|   検索開始     |---->|   検索語生成   |---->|  ウェブ検索実行  |---->|  結果抽出処理  |
+----------------+     +----------------+     +----------------+     +----------------+
                                                                            |
                                                                            v
+----------------+     +----------------+     +----------------+     +----------------+
| データベース保存 |<----|  人間による検証  |<----|  LLM二次検証   |<----|  LLM一次検証   |
+----------------+     +----------------+     +----------------+     +----------------+
        |
        |
        v
+----------------+     +----------------+
|  統計情報更新  |---->|  結果表示     |
+----------------+     +----------------+
```

## 3. 検索プロセスの詳細フロー

### 3.1 基本検索フロー

```
ユーザー入力 → 疾患検索 → 疾患選択 → 組織情報表示
```

### 3.2 LLM拡張検索フロー

```
疾患選択 → 検索語準備 → LLM検索実行 → 結果抽出 → LLM検証 → 人間検証 → 結果表示
```

### 3.3 全疾患一括検索フロー

```
一括検索開始 → 疾患リスト取得 → 各疾患に対して検索実行 → 結果集計 → 統計表示
```

## 4. 情報収集プロセス

### 4.1 検索語生成プロセス

```
+----------------+     +----------------+     +----------------+
|   基本疾患名   |---->|  検索語テンプレート |---->|  検索語バリエーション |
+----------------+     +----------------+     +----------------+
      |                      |                      |
      |                      |                      |
      v                      v                      v
+----------------+     +----------------+     +----------------+
|  日本語検索語  |     |   英語検索語   |     |  カスタム検索語  |
+----------------+     +----------------+     +----------------+
      |                      |                      |
      +----------------------+----------------------+
                            |
                            v
                    +----------------+
                    |  検索語リスト   |
                    +----------------+
```

### 4.2 LLM検証プロセス

```
+----------------+     +----------------+     +----------------+
|  スクレイピング結果 |---->|  テキスト抽出   |---->|  LLMプロンプト生成 |
+----------------+     +----------------+     +----------------+
                                                      |
                                                      v
+----------------+     +----------------+     +----------------+
|  検証結果保存  |<----|  結果構造化    |<----|  LLM推論実行   |
+----------------+     +----------------+     +----------------+
```

### 4.3 人間検証プロセス

```
+----------------+     +----------------+     +----------------+
|  検証待ちリスト |---->|  検証UI表示    |---->|  ユーザー判断   |
+----------------+     +----------------+     +----------------+
                                                      |
                                                      v
+----------------+     +----------------+     +----------------+
|  統計更新     |<----|  検証結果保存   |<----|  承認/拒否選択  |
+----------------+     +----------------+     +----------------+
```

## 5. データフロー

### 5.1 検索リクエストフロー

```
ユーザー → フロントエンド → API → バックエンド → 検索モジュール → ウェブスクレイピング → LLM処理 → データベース → API → フロントエンド → ユーザー
```

### 5.2 検証リクエストフロー

```
ユーザー → 検証UI → API → 検証モジュール → データベース更新 → 統計更新 → API → フロントエンド → ユーザー
```

## 6. LLM連携アーキテクチャ

```
+----------------------------------+
|          LLM連携モジュール        |
+----------------------------------+
|                                  |
|  +----------------------------+  |
|  |      プロバイダーインターフェース |  |
|  +----------------------------+  |
|  | - モデル一覧取得            |  |
|  | - 推論実行                 |  |
|  | - トークン計算             |  |
|  +----------------------------+  |
|                                  |
|  +------------+  +------------+  |
|  |   Ollama   |  | LM Studio  |  |
|  +------------+  +------------+  |
|  | - Llama3   |  | - Qwen30B  |  |
|  | - Llama4   |  | - Qwen32B  |  |
|  +------------+  +------------+  |
|                                  |
|  +------------+  +------------+  |
|  |    MLX     |  | llama.cpp  |  |
|  +------------+  +------------+  |
|  | - Mistral  |  | - Llama3   |  |
|  | - Qwen     |  | - Llama4   |  |
|  +------------+  +------------+  |
|                                  |
+----------------------------------+
```

## 7. 検索戦略の詳細

### 7.1 検索アプローチ

本システムは以下の3つの主要な検索アプローチを採用しています：

1. **完全一致検索**：疾患名と完全に一致する団体を検索
   - 例：「白血病」→「白血病患者会」

2. **近似マッチング検索**：LLMを活用して、疾患名と完全一致しなくても関連性の高い団体を検索
   - 例：「白血病」→「血液がんの会」（白血病は血液がんの一種）

3. **拡張検索語検索**：複数の検索語を組み合わせた検索
   - 例：「白血病 患者会」「白血病 家族会」「白血病 支援団体」「leukemia patient group」

### 7.2 検索語生成ロジック

各疾患に対して、以下のパターンで検索語を生成します：

1. **基本検索語**：疾患名そのもの
   - 例：「白血病」「筋ジストロフィー」

2. **組織タイプ検索語**：疾患名 + 組織タイプ
   - 例：「白血病 患者会」「白血病 家族会」「白血病 支援団体」

3. **言語バリエーション**：日本語と英語
   - 例：「白血病」と「leukemia」

4. **カスタム検索語**：ユーザーが追加した検索語
   - 例：「血液がん」「血液腫瘍」

### 7.3 近似マッチングロジック

近似マッチングは以下のプロセスで実行されます：

1. 疾患名と検索結果のテキストをLLMに入力
2. LLMが以下の判断を行う：
   - テキスト内に疾患名が直接含まれているか
   - テキスト内に疾患の別名や関連疾患名が含まれているか
   - テキストの内容が対象疾患と関連しているか
3. 関連性スコア（0〜100）を算出
4. スコアが閾値（デフォルト: 70）以上の場合、関連ありと判定

### 7.4 二段階LLM検証プロセス

LLM検証は以下の二段階で実行されます：

1. **一次検証（抽出フェーズ）**：
   - ウェブページのテキストから組織情報を抽出
   - 組織名、URL、説明文、連絡先情報を構造化
   - 組織タイプ（患者会、家族会、支援団体など）を分類

2. **二次検証（検証フェーズ）**：
   - 抽出された組織情報の正確性を検証
   - 疾患との関連性を評価（0〜100のスコア）
   - 情報の信頼性を評価
   - 検証結果に基づいて検証ステータスを更新

## 8. 技術仕様

### 8.1 使用モデル

| モデル名 | 提供方法 | 言語サポート | トークン上限 | 用途 |
|---------|---------|------------|------------|------|
| Qwen30B-A3B | LM Studio | 日本語・英語 | 8K | 一般検証 |
| Qwen32B | LM Studio | 日本語・英語 | 8K | 一般検証 |
| Llama3 70B 4bit | Ollama | 日本語・英語 | 8K | 高精度検証 |
| Llama4 Scour 4bit | Ollama | 英語（日本語限定的） | 128K | 大量テキスト処理 |

### 8.2 トークン使用量モニタリング

各LLM操作のトークン使用量を以下の項目で追跡します：

- プロンプトトークン数
- 完了トークン数
- 合計トークン数
- 使用モデル
- タイムスタンプ

### 8.3 検索設定オプション

ユーザーは以下の検索設定をカスタマイズできます：

- **近似マッチング**：LLMによる関連性判断を有効/無効
- **二段階検証**：LLMによる二段階検証プロセスを有効/無効
- **人間検証要件**：人間による最終検証を必須にするかどうか
- **トークン上限**：1回の検索で使用する最大トークン数
- **検索語**：使用する検索語の追加・編集・削除

## 9. 実装の詳細

### 9.1 バックエンド（FastAPI）

- **データ処理モジュール**：疾患データの読み込みと処理
- **検索モジュール**：検索語の生成と検索実行
- **スクレイピングモジュール**：ウェブページの取得と解析
- **LLM連携モジュール**：ローカルLLMとの通信
- **検証モジュール**：情報の検証と評価
- **API**：フロントエンドとの通信インターフェース

### 9.2 フロントエンド（React + TypeScript）

- **検索インターフェース**：疾患検索と結果表示
- **詳細表示**：疾患と組織の詳細情報表示
- **検索語エディタ**：検索語の追加・編集・削除
- **検証パネル**：人間による検証インターフェース
- **統計表示**：検索統計とトークン使用量の表示

## 10. 今後の拡張予定

- **多言語サポートの強化**：より多くの言語での検索と情報収集
- **医療文献連携**：PubMedなどの医療文献データベースとの連携
- **臨床試験情報**：進行中の臨床試験情報の自動収集
- **ソーシャルメディア分析**：SNS上の患者コミュニティ情報の収集
- **国際的な支援団体情報**：国際的な希少疾患支援団体の情報収集
